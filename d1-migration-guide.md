# Руководство по миграции с Firebase Firestore на Cloudflare D1

## Обзор миграции

Этот документ описывает стратегию миграции базы данных проекта BelAutoCenter с Firebase Firestore на Cloudflare D1. Миграция включает преобразование документно-ориентированной модели данных Firestore в реляционную модель SQLite, используемую в D1.

## Сопоставление коллекций Firestore с таблицами D1

| Коллекция Firestore | Таблица(ы) D1 | Комментарий |
|--------------------|---------------|-------------|
| employees | employees | Прямое соответствие |
| organizations | organizations | Прямое соответствие |
| services | services | Прямое соответствие |
| carWashRecords | car_wash_records + car_wash_participants | Массив participant_ids разделен на отдельную таблицу |
| dailyReports | daily_reports + daily_employees + daily_employee_roles | Массивы и вложенные объекты нормализованы |
| appointments | appointments | Прямое соответствие |
| settings | settings | Прямое соответствие, данные хранятся как JSON строка |

## Нормализация данных

### Основные изменения в структуре данных:

1. **Массивы:**
   - Массивы ID (например, `participant_ids` в `carWashRecords`) заменены на связующие таблицы с отношениями many-to-many.
   - Пример: `car_wash_participants` связывает записи мойки с сотрудниками.

2. **JSON-объекты:**
   - Сложные JSON-объекты (например, `payment_method`) хранятся как сериализованные JSON-строки.
   - Приложение отвечает за сериализацию/десериализацию этих данных.

3. **Вложенные документы:**
   - Вложенные документы разделены на отдельные таблицы с внешними ключами.
   - Пример: `daily_employee_roles` заменяет поле `dailyEmployeeRoles` в `dailyReports`.

## Представления (Views)

Для упрощения доступа к данным и сохранения API, похожего на текущий, созданы представления (views):

1. **v_car_wash_records_full**
   - Объединяет записи мойки с участниками (сотрудниками)
   - Возвращает список участников в формате, аналогичном массиву `participant_ids` в Firestore

2. **v_daily_reports_full**
   - Объединяет ежедневные отчеты со списком сотрудников
   - Эмулирует структуру документов Firestore для более простого перехода

## Отличия типов данных

| Тип в Firestore | Тип в D1 (SQLite) | Комментарий |
|----------------|-------------------|-------------|
| string | TEXT | Прямое соответствие |
| number | REAL | SQLite не имеет отдельного типа для денежных значений |
| boolean | INTEGER | В SQLite булевы значения хранятся как 0 или 1 |
| timestamp | TIMESTAMP | Формат `datetime('now')` в SQLite |
| array | Отдельная таблица | Массивы нормализованы в отдельные таблицы |
| map/object | TEXT (JSON) | Сложные объекты сериализуются в JSON |

## Индексы

В схеме созданы следующие индексы для ускорения запросов:

1. **idx_car_wash_records_date**
   - Ускоряет поиск записей мойки по дате

2. **idx_appointments_date**
   - Ускоряет поиск записей на определенную дату

3. **idx_appointments_date_status**
   - Ускоряет поиск записей с определенным статусом на определенную дату

## Автоматические обновления полей

Для всех таблиц созданы триггеры, автоматически обновляющие поле `updated_at` при изменении записи.

## Процесс миграции данных

Рекомендуемые шаги для миграции данных:

1. **Экспорт данных из Firestore:**
   - Использовать Firebase Admin SDK или Firestore Export для экспорта данных
   - Сохранить данные в формате JSON

2. **Преобразование данных:**
   - Написать скрипт для преобразования структуры JSON из Firestore в структуру, соответствующую таблицам D1
   - Особое внимание уделить нормализации массивов и вложенных объектов

3. **Импорт данных в D1:**
   - Использовать Cloudflare D1 API или Wrangler CLI для импорта данных
   - Учесть зависимости между таблицами (сначала импортировать основные таблицы, затем связующие)

4. **Проверка данных:**
   - Выполнить проверку целостности данных
   - Убедиться, что все запросы в приложении работают корректно

## Обновление кода приложения

Основные изменения в коде приложения:

1. **Запросы к базе данных:**
   - Переписать запросы с Firebase SDK на SQL-запросы к D1
   - Использовать представления (views) для упрощения сложных запросов

2. **Работа с JSON:**
   - Добавить сериализацию/десериализацию JSON для полей, хранящихся как TEXT
   - Пример: `payment_method` в `car_wash_records`

3. **Транзакции:**
   - Заменить транзакции Firestore на транзакции SQLite
   - Учесть разницу в поведении и возможностях

4. **ID генерация:**
   - Реализовать генерацию UUID на стороне приложения
   - Альтернатива: использовать D1 Auto-Increment ID

## Преимущества миграции на D1

1. **Стоимость и производительность:**
   - Cloudflare D1 может быть более экономичным решением для определенных сценариев
   - Меньшая задержка для пользователей благодаря глобальной сети Cloudflare

2. **SQL-возможности:**
   - Полноценный SQL для сложных запросов и аналитики
   - JOIN-операции для эффективной работы с связанными данными

3. **Интеграция с Cloudflare Workers:**
   - Бесшовная интеграция с другими сервисами Cloudflare
   - Возможность использования D1 в edge-функциях

## Ограничения и особенности D1

1. **Ограничения SQLite:**
   - Отсутствие некоторых типов данных (UUID, ARRAY)
   - Ограниченная поддержка индексов для JSON-данных

2. **Масштабирование:**
   - D1 имеет ограничения на размер базы данных и частоту запросов
   - Мониторинг и управление квотами

3. **Репликация и резервное копирование:**
   - Разные подходы к резервному копированию по сравнению с Firestore
   - Настройка автоматического резервного копирования
